<!DOCTYPE html>
<html>
<head>
    <title>MathApp</title>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="/CSS/styles.css"/>
        <link rel="stylesheet" type="text/css" href="/CSS/aww.css"/>
        <link rel="stylesheet" href="/js/jquery-tags-input-1.3.2/jquery.tagsinput.css">
				<link href='http://fonts.googleapis.com/css?family=Lato:100' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
		<style>
		@font-face {
			font-family:"Merriweather";
			src:url("/font/merriweather/Merriweather-Light.ttf");
		}
		body {
			font-family:"Merriweather" !important;
            height: 100%;
		}
		#content {
            float: right;
            width: 80%;
            margin:0;
            padding:0;
            height:100%;
        }

        #bigHeader {
            width:125%;
        }

        h1, h2, h3, h4, h5, h6 {
			font-family:"Merriweather" !important;
		}

		input[type='text'] {
			font-family:"Merriweather";
		}
        .row {
            position: relative;
            top: 0;
            width: 100%;
            overflow: hidden;
        }

        #problem_text {
            text-align: center;
        }

        .draggable {
            padding: 0.5em;
            border: 1px solid #555555;
            border-radius: 5px;
            height:200px;
            min-height:150px;
            min-width:150px;
            width:200px;
            background: #ffffff;
						overflow:scroll;
        }

        .draggable .minimize {
            font-weight:bold;
            font-size: 10pt;
            text-align: right;
            margin: -10px;
        }
				
        #error {
            font-weight:bold;
            color:red;
        }

        #sidebar {
            float: left;
            width: 16%;
            position: absolute;
            height: 100%;
            padding-right: 0;
            padding-bottom: 0;
            min-height: 700px;
        }

        #menu {
            background-color: rgb(46, 46, 46);
            position: absolute;
            height:100%;
            width:100%;
            color: #46a9b2;
            font-family: 'Lato', sans-serif;
        }

        #icon {
            margin-left:auto;
            margin-right:auto;
        }

        #menu {
            padding: 10px;
        }

        .menuList {
            list-style-type:none;
        }
        .menuList li {
            border-bottom: 1px solid white;
            padding-top:20px;
            padding-bottom:20px;
            font-size:18px;
        }
				#dialog {
					opacity:1.0;
					z-index:999;
				}
        #sidebar_header {
            font-family: 'Montserrat', sans-serif;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 16pt;
					}

        .menuList li:first-of-type {
            border-top: 1px solid white;
        }

        #open_panel_icon {
            height: 50px;
            width: 50px;
            position: relative;
            left: -400px;
            background-color: rgb(46, 46, 46);
            padding: 10px;
            border:2px solid;
            border-top-right-radius:2em;
            border-bottom-right-radius:2em;
            z-index: 1;
        }

				#output {
					background-color:#CCCCCC;
				}
				#emails_tagsinput {
					width:100% !important;
					font-family:"Merriweather" !important;
					height:70% !important;
				}
		</style>
		<link rel="stylesheet" type="text/css" href="/foundation-5.0.3/css/foundation.css"/>

		<script src="http://static.opentok.com/v1.1/js/TB.min.js"></script>
		<script src="/js/jquery.js"></script>
		<script src="/js/jquery-ui.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/js/jquery-tags-input-1.3.2/jquery.tagsinput.js"></script>
        <script type="text/javascript" src="/js/aww.min.js"></script>
        <script>

        $(function() {
					
					window.name = "";
					
					$("#nameInput").keypress(function(e) {
						if(e.keyCode == 13) {
							e.preventDefault();
							window.name = $(this).val();
							var $dialog = $(this).parent();
							$(this).remove();
						  $dialog.text("Name changed to " + name);
							setTimeout(function() {
								$dialog.fadeOut(500);
							}, 1000);
						}
					});
					
					window.wasAlreadyMinimized = 0;
					
			    var apiKey    = "44618172";
			    var sessionId = "1_MX40NDYxODE3Mn5-U2F0IEphbiAxOCAwMDowMjoxNCBQU1QgMjAxNH4wLjU2MTYxNjg0fg";
			    var token     = "T1==cGFydG5lcl9pZD00NDYxODE3MiZzZGtfdmVyc2lvbj10YnJ1YnktdGJyYi12MC45MS4yMDExLTAyLTE3JnNpZz01MmM0ZjJlZTY2NmZjYjg5NTNjMTgwZWJkNzMzOWFjOGY5YTZjZDVlOnJvbGU9cHVibGlzaGVyJnNlc3Npb25faWQ9MV9NWDQwTkRZeE9ERTNNbjUtVTJGMElFcGhiaUF4T0NBd01Eb3dNam94TkNCUVUxUWdNakF4Tkg0d0xqVTJNVFl4TmpnMGZnJmNyZWF0ZV90aW1lPTEzOTAwMzIxODEmbm9uY2U9MC4wMTgwMjM1MDEwOTE0NTQ0NTImZXhwaXJlX3RpbWU9MTM5MDYzNjk4MSZjb25uZWN0aW9uX2RhdGE9";
					
					
					// OpenTok
					/*var session = TB.initSession(sessionId);
					var API_KEY = "44618111";
					
					session.addEventListener("sessionConnected", sessionConnectedHandler);
					session.addEventListener("streamCreated", streamCreatedHandler);
					
					function sessionConnectedHandler(event) {
						subscribeToStreams(event.streams);
						session.publish();
					}
					
					function subscribeToStreams(streams) {
						for(var i = 0; i < streams.length; i++) {
							var stream = streams[i];
							if(stream.connection.connectionId != session.connection.connectionId) {
								session.subscribe(stream, "placeholder", {width: 400, height: 400});
							}
						}
					}
					
					function streamCreatedHandler(event) {
						subscribeToStreams(event.streams);
					}
					
					session.connect(API_KEY, token);*/
					
					
					// chat websocket
					
					var socket = io.connect('http://'+document.domain);
					
            $("#msg").keypress(function(e) {
								if(e.keyCode == 13) {
									e.preventDefault();
									if($(this).val() != '') {
										var messageText = $(this).val();
										$(this).val('');
										socket.emit('chatMessage', {"messageText": messageText, "sendingUser": window.name});
									}
								}
					    socket.on('chatMessage', function(data) {
							var msgEl = $("<ul class='messageText'>"+"<b>"+data['sendingUser']+"</b>: "+data['messageText']+"</ul>");
							$("#chat-msgs").append(msgEl);
						});
					});
					
					// jquery animations
            // sidebar animations
            $("#icon").click(function(){
                $("#menu").css( {
                    "padding": "0"
                })

                $("#sidebar").animate( {
                    "width": "0"
                }, { duration: 250, queue: false })

                $("#content").animate( {
                    "width": "100%"

                })

                $("#sidebar_header").animate({
                    "color": "white",
                    "z-index":"-1"
                }, { duration: 150, queue: false })

                $("li a").css({
                    "color": "white"
                })



                $("#open_panel_icon").animate({
                    "left":'0px'
                },{ duration: 500, queue: false })
            });

            $("#open_panel_icon").click(function() {
                $("#open_panel_icon").animate({
                    "left":'-400px'
                },{ duration: 500, queue: false })

                $("li a").css({
                    "color": "#46a9b2"
                })

                $("#sidebar_header").animate({
                    "color": "white",
                    "z-index":"-1"
                }, { duration: 150, queue: false })

                $("#content").animate( {
                    "width": "84%"

                })

                $("#sidebar").animate( {
                    "width": "16%"
                }, { duration: 250, queue: false })

                $("#menu").css( {
                    "padding": "10px"
                })

            })

            $("#problem_text").hide();
            $(".draggable").hide();

            $("#problem_text").fadeIn(500);
            $(".draggable").delay(500).fadeIn(500);
            $(".draggable").draggable();
            $(".draggable").resizable();
            $(".draggable").mouseover(function() {
                $(this).animate({
                 "border-color": "#494949",
                 "border-width": "0.2em"
                 }, 100);
            });
						
            $(".draggable").mouseleave(function() {
                $(this).animate({
                    "border-color": "#9D9D9D",
                    "border-width": "1px"
                }, 100);
				    });

            $(".minimize").click(function() {
                $(this).parent().css({
                      'min-height': '0px',
                      'min-width': '0px',
                      'position': 'fixed'
                });

                $(this).parent().animate({
                    "height": "40px",
                    "width": "200px",
                    "background-color": "#9E9E9E",
                    "bottom": "0px",
										"left": 200*window.alreadyMinimized+"px"
                }, 500);
								
								window.alreadyMinimized++;

                /*$(this).parent().html("");*/
            });
						
						// wolframalpha
						
						$("#calc").keypress(function(e) {
							if(e.keyCode == 13) {
								e.preventDefault();
								if($(this).val() != '') {
									var exp = $(this).val();
									$(this).val('');
									$("#result").text('');
									$("#error").text('');
									$.post('/calc', {'exp': exp}, function(data) {
										var parsed = JSON.parse(data);
										if(parsed['status'] == 'ok') {
											$("#result").text(parsed['result']);
											socket.emit('valueCalculated', {'sendingUser': window.name, 'value': parsed['result']});
										}
										else {
											$("#error").text(parsed['error'])
										}
									});
								}
							}
						});
						
						socket.on('valueCalculated', function(data) {
							var logEl = $("<ul class='messageText'>"+"<b>"+data['sendingUser']+"</b>: "+data['value']+"</ul>");
							$("#calc-log").prepend(logEl);
						});

						$("#invite").click(function() {
							var $emailBar = $("<div class='callout panel'><p>Type each email, separated by commas.</p><input type='text' id='emails' placeholder='Emails, separated by commas...'/></div>");
							$("body").prepend($emailBar);
							$("#emails").tagsInput();
						});
						
        });

    </script>
</head>
<body>
	<div class="overlay">
		<div class="callout panel" id="dialog">
			<input type="text" id="nameInput" placeholder="Please enter your name..."/>
		</div>
    <div id="sidebar">

        <div id="menu">
            <p style="text-align: right" id="sidebar_header">
                Math App&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <img src="/images/iconmonstr-menu-icon-32.png" style="cursor:pointer;" alt="sidebar icon" id="icon"/>
            </p>
            <p>
                <ul class="menuList">
                    <li><a href="#" id="invite">Invite collaborators</a></li>
                    <li><a href="#" id="save">Save solution</a></li>
                    <li><a href="#" id="clear">Clear workspace</a></li>
                </ul>
            </p>
        </div>
    </div>
    <div id="content">
        <span><img src="/images/iconmonstr-menu-icon-32.png" alt="open menu" id="open_panel_icon"/></span>
        <div class="row panel" id="bigHeader">
            <h3 id="problem_text"><%= problemText %></h3>
        </div>

				<div class="row">
	        <div class="draggable ui-widget-content large-8 medium-8 small-8 columns" id="board">
	            <p class="minimize">_</p>
							<p>Whiteboard</p>
	            <div id="wrapper"></div> <script type="text/javascript">
	                $(function() { $('#wrapper').awwCanvas(); });
	            </script>
	        </div>

	        <div class="draggable ui-widget-content large-4 medium-4 small-4 columns" id="chat">
							<p class="minimize">_</p>
							 <p>Chat</p>
	             <ul id="chat-msgs">
	             </ul>
	             <input type="text" id="msg"/>
	        </div>
				</div>
				
				<div class="row">
				
					<div class="draggable ui-widget-content large-4 medium-4 small-4 columns" id="wolfram">
						<p class="minimize">_</p>
						<p>Calculator</p>
						<input type="text" id="calc" placeholder="e.g. 2+2"/>
						<div id="result"></div>
						<div id="error"></div>
						<b>Recent calculations:</b>
						<ul id="calc-log">
						</ul>
					</div>
				
					<div class="draggable ui-widget-content large-4 medium-4 small-4 columns" id="tokbox">
						<p class="minimize">_</p>
						<p>Video chat</p>
						<div id="placeholder">
						</div>
					</div>
					
					<div class="draggable ui-widget-content large-4 medium-4 small-4 columns" id="output">
						<p class="minimize">_</p>
						<p>Output</p>
						<textarea id="solution">
						</textarea>
					</div>
					
				</div>
				
				
				
    </div>
	</div>
</body>
</html>