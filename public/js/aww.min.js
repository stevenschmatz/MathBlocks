(function(f){f(function(){f.extend(f.support,{touch:typeof Touch=="object"});if(document.addEventListener){document.addEventListener("touchstart",a,false);document.addEventListener("touchmove",a,false);document.addEventListener("touchend",a,false);document.addEventListener("touchcancel",a,false)}});var b=null;var m=false;var k=null;function d(){m=false}var i=false;var e=null;var c=null;var h=false;function g(){if(i){window.clearTimeout(c);i=false;e=null}}function j(o){if(i){return}i=true;e=(o.changedTouches)[0];c=window.setTimeout("doRightClick();",800)}function n(){i=false;var p=e,o=document.createEvent("MouseEvent");o.initMouseEvent("mouseup",true,true,window,1,p.screenX,p.screenY,p.clientX,p.clientY,false,false,false,false,0,null);p.target.dispatchEvent(o);o=document.createEvent("MouseEvent");o.initMouseEvent("mousedown",true,true,window,1,p.screenX,p.screenY,p.clientX,p.clientY,false,false,false,false,2,null);p.target.dispatchEvent(o);o=document.createEvent("MouseEvent");o.initMouseEvent("contextmenu",true,true,window,1,p.screenX+50,p.screenY+5,p.clientX+50,p.clientY+5,false,false,false,false,2,null);p.target.dispatchEvent(o);h=true;e=null}function l(q){var s=q.changedTouches,r=s[0],o="mouseover",p=document.createEvent("MouseEvent");p.initMouseEvent(o,true,true,window,1,r.screenX,r.screenY,r.clientX,r.clientY,false,false,false,false,0,null);r.target.dispatchEvent(p);o="mousedown";p=document.createEvent("MouseEvent");p.initMouseEvent(o,true,true,window,1,r.screenX,r.screenY,r.clientX,r.clientY,false,false,false,false,0,null);r.target.dispatchEvent(p);if(!m){b=r.target;m=true;k=window.setTimeout("cancelTap();",600);j(q)}else{window.clearTimeout(k);if(r.target==b){b=null;m=false;o="click";p=document.createEvent("MouseEvent");p.initMouseEvent(o,true,true,window,1,r.screenX,r.screenY,r.clientX,r.clientY,false,false,false,false,0,null);r.target.dispatchEvent(p);o="dblclick";p=document.createEvent("MouseEvent");p.initMouseEvent(o,true,true,window,1,r.screenX,r.screenY,r.clientX,r.clientY,false,false,false,false,0,null);r.target.dispatchEvent(p)}else{b=r.target;m=true;k=window.setTimeout("cancelTap();",600);j(q)}}}function a(r){var p="",o=0;if(r.touches.length>1){return}switch(r.type){case"touchstart":if(f(r.changedTouches[0].target).is("select")){return}l(r);r.preventDefault();return false;break;case"touchmove":g();p="mousemove";r.preventDefault();break;case"touchend":if(h){h=false;r.preventDefault();return false}g();p="mouseup";break;default:return}var t=r.changedTouches,s=t[0],q=document.createEvent("MouseEvent");q.initMouseEvent(p,true,true,window,1,s.screenX,s.screenY,s.clientX,s.clientY,false,false,false,false,o,null);s.target.dispatchEvent(q);if(p=="mouseup"&&m&&s.target==b){q=document.createEvent("MouseEvent");q.initMouseEvent("click",true,true,window,1,s.screenX,s.screenY,s.clientX,s.clientY,false,false,false,false,o,null);s.target.dispatchEvent(q)}}})(jQuery);(function(d){var g=2;var a=5;var e=10;var b=20;var c="bold 14px verdana, sans-serif";var f={red:"#ed1c24",green:"#009945",blue:"#00a4ed",black:"#000",yellow:"#ffff00",brown:"#6b5534",purple:"#9b559b"};d.fn.awwCanvas=function(F){if((this.length==1)&&!F&&d(this).data("aww")){return d(this).data("aww")}var L={apiKey:"",orientation:"auto",toolbar:true,smallIcons:false,shrinkCanvas:true,autoJoin:true,singleBoardId:null,invite_handler:null,post_handler:null,font:c,saveUrl:"http://awwapp.com/save/",translation:{},msgbox_handler:function(Z){alert(Z)},prompt_handler:function(aa,Z){return prompt(aa,Z)},confirm_handler:function(Z){return confirm(Z)},onReady:function(){}};F=d.extend(L,F);var S=document.createElement("canvas");if(!S){return null}var B=false;if(window.G_vmlCanvasManager){S.width=1;S.height=1;S=window.G_vmlCanvasManager.initElement(S);B=true}if(!S.getContext){return null}var H=null;var k=null;var z=false;var V=false;function R(Z){H=Z}function P(Z){k=Z}function Y(Z){if(F.translation.hasOwnProperty(Z)){return F.translation[Z]}else{return Z}}var K=d('<div class="awwcanvas">');function s(Z,aa){return d("<li>").addClass(Z).append(d('<a href="#">').attr("title",Y(aa)).append(d("<span>/")).append(Y(aa)))}var q=d('<div class="toolbar">').appendTo(K);var p=d('<ul class="navigation">').appendTo(q);var U=s("color submenu","Color").appendTo(p);var y=d("<ul>").append(s("red","Red")).append(s("green","Green")).append(s("blue","Blue")).append(s("black","Black")).append(s("yellow","Yellow")).append(s("brown","Brown")).append(s("purple","Purple")).appendTo(U);var o=s("pencil submenu","Pencil").appendTo(p);var C=d("<ul>").append(s("thin","Thin")).append(s("medium","Medium")).append(s("thick","Thick")).append(s("text","Text")).append(s("eraser","Eraser")).appendTo(o);var I=s("menu submenu","Menu").appendTo(p);var G=d("<ul>").append(s("new","Clear")).append(s("share","Invite")).append(s("link","Post")).append(s("save","Save")).appendTo(I);function n(){if(!F.toolbar){K.addClass("aww-notoolbar").removeClass("aww-portrait aww-landscape smallcanvas");return}var Z=K.width();var aa=K.height();if((Z<550)||(aa<550)||F.smallIcons){K.addClass("smallcanvas")}else{K.removeClass("smallcanvas")}if((F.orientation=="landscape")||((F.orientation=="auto")&&(Z>=aa))){K.addClass("aww-landscape").removeClass("aww-portrait")}else{K.addClass("aww-portrait").removeClass("aww-landscape")}}d("li.submenu > a",p).click(function(){var aa=d(this).closest("li");var Z=aa.hasClass("selected");d("> li",p).removeClass("selected showsubmenu");if(!Z){aa.addClass("selected showsubmenu")}return false});d("li.color ul li a",p).click(function(){d("li.color ul li",p).removeClass("selected");var Z=d(this).closest("li");d.each(f,function(aa){if(Z.hasClass(aa)){R(""+this)}});d("li.color",p).removeClass("selected showsubmenu");Z.addClass("selected");return false});d("li.pencil ul li a",p).click(function(){d("li.pencil ul li",p).removeClass("selected");var Z=d(this).closest("li");z=false;V=false;if(Z.hasClass("thin")){P(g)}else{if(Z.hasClass("medium")){P(a)}else{if(Z.hasClass("thick")){P(e)}else{if(Z.hasClass("eraser")){z=true}else{if(Z.hasClass("text")){V=true}}}}}d("li.pencil",p).removeClass("selected showsubmenu");Z.addClass("selected");return false});d("li.new a",p).click(function(){setTimeout(function(){if(F.confirm_handler(Y("This will destroy your current drawing.\nDo you really want to continue?"))){M.doClear()}},100);d("li.menu",p).removeClass("selected showsubmenu");return false});d("li.link a",p).click(function(){d("li.menu",p).removeClass("selected showsubmenu");if(F.post_handler){F.post_handler.call(M)}else{A("post")}return false});d("li.save a",p).click(function(){d("li.menu",p).removeClass("selected showsubmenu");A("save");return false});d("li.share a",p).click(function(){var Z=d(this).closest("li");d("li.menu",p).removeClass("selected showsubmenu");if(F.invite_handler){return F.invite_handler.call(M)}if(M.isShared()){setTimeout(function(){if(F.confirm_handler(Y("Stop sharing?"))){M.leaveBoard();Z.removeClass("selected")}},100)}else{M.createBoard(function(aa){if(aa){Z.addClass("selected");setTimeout(function(){F.prompt_handler.call(M,Y("Invite people by sharing this URL."),window.location.href)},500)}else{F.msgbox_handler.call(M,Y("Cannot share the drawing, sorry"))}})}return false});var N=d('<input type="hidden" name="apikey">').val(F.apiKey||"");var m=d('<form target="_blank" method="post">').attr("action",F.saveUrl).append(N).append('<input type="hidden" name="action" value="">').append('<input type="hidden" name="image" value="">');d('<div style="display: none; position: absolute; width: 0; height: 0;">').append(m).appendTo(K);var x=d('<div class="whiteboard">').appendTo(K);var w=d(S).css({padding:"0",margin:"0",border:"0",shadow:"0",overflow:"hidden"}).appendTo(x);var X=S.getContext("2d");X.lineCap="round";X.lineJoin="round";X.fillStyle="black";X.globalCompositeOperation="source-over";function D(Z,aa){if(B){}else{X.globalCompositeOperation="destination-out";X.beginPath();X.arc(Z,aa,b,0,Math.PI*2);X.fill();X.globalCompositeOperation="source-over"}}function E(Z,ad,aa,ac,ab,ae){X.lineCap="round";X.lineJoin="round";X.lineWidth=ad;X.strokeStyle=Z;X.beginPath();X.moveTo(ab,ae);X.lineTo(aa,ac);X.stroke()}function T(ab,Z,ad,ac,aa){aa=aa||"bold 12px sans-serif";X.fillStyle=ab;X.font=aa;X.textBaseline="middle";X.fillText(ac,Z,ad)}function J(){X.clearRect(0,0,w.width(),w.height())}function t(){var Z=S.toDataURL();return Z}function A(Z){Z=Z||"save";var aa=t();d("input[name='action']",m).val(Z);d("input[name='image']",m).val(aa);m.submit()}function h(Z){var aa=t();d("input[name='action']",m).val("ajaxsave");d("input[name='image']",m).val(aa);d.post(m.attr("action"),m.serialize(),function(ab){Z(ab)},"json")}function l(Z,ac,aa,ab){if(X.getImageData){return X.getImageData(Z,ac,aa,ab)}else{return{}}}function O(ae,ab,ad,Z,af,aa,ac){if(X.putImageData){return X.putImageData(ae,ab,ad,Z,af,aa,ac)}}window.allOps=[];var M={awwcanvas:K[0],options:F,toolbar:q[0],whiteboard:x[0],canvas:S,operations:[],resize_timeout:null,board_id:null,resize:function(){n();var aa=w.width();var ac=w.height();var ad=l(0,0,aa,ac);var Z=x.width();var ab=x.height();if(!F.shrinkCanvas){if(Z<aa){Z=aa}if(ab<ac){ab=ac}}if(aa>Z){aa=Z}if(ac>ab){ac=ab}w.attr({width:Z,height:ab});O(ad,0,0,0,0,aa,ac)},doErase:function(Z,aa){this.addOp("doErase",{x:Z,y:aa});D(Z,aa)},doDrawLine:function(Z,ad,aa,ac,ab,ae){this.addOp("doLine",{color:Z,width:ad,x1:aa,y1:ac,x0:ab,y0:ae});E(Z,ad,aa,ac,ab,ae)},doDrawText:function(ab,Z,ad,ac,aa){this.addOp("doText",{color:ab,text:ac,x:Z,y:ad,font:aa});T(ab,Z,ad,ac,aa)},doClear:function(){this.operations=[];this.addOp("doClear",{});J()},saveImage:function(){A("save")},postImage:function(){A("post")},doAjaxPostImage:function(Z){h(Z)},addOp:function(aa,Z){Z.op=aa;this.operations.push(Z)},pushOps:function(){if(!this.board_id||!this.operations.length){return}var Z=this.operations.slice(0,2000);this.operations=this.operations.slice(2000);now.sendOpBatch(this.board_id,Z,function(){M.pushOps()})},replayOps:function(aa){for(var Z=0;Z<aa.length;Z++){var ab=aa[Z];if(ab.clientId&&(ab.clientId==now.core.clientId)){continue}window.totalOps++;window.allOps.push(ab);if(ab.op=="doErase"){D(ab.x,ab.y)}else{if(ab.op=="doLine"){E(ab.color,ab.width,ab.x1,ab.y1,ab.x0,ab.y0)}else{if(ab.op=="doText"){T(ab.color,ab.x,ab.y,ab.text,ab.font||F.font)}else{if(ab.op=="doClear"){J()}}}}}},isShared:function(){if(this.board_id){return true}else{return false}},getBoardId:function(){return this.board_id},getHashFragment:function(){var Z=window.location.hash;if(Z.indexOf("#")===0){Z=Z.slice(1)}return Z},updateHashFragment:function(Z){window.location.hash=Z},joinBoard:function(aa,Z){Z=Z||function(){};if(!window.now||this.board_id){Z.call(M,null);return}now.joinBoard(aa,function(ab){if(ab){M.board_id=aa;setInterval(function(){M.pushOps()},500);M.updateHashFragment(aa);Z.call(M,aa)}else{M.updateHashFragment("");Z.call(M,null)}})},createBoard:function(Z){Z=Z||function(){};if(!window.now||this.board_id){Z.call(M,false);return}now.createBoard(function(aa){if(aa===null){Z.call(M,null)}else{M.updateHashFragment(aa);M.joinBoard(aa,Z)}})},createNamedBoard:function(aa,Z){Z=Z||function(){};if(!window.now||this.board_id){Z.call(M,null);return}now.createNamedBoard(aa,function(ab){if(ab===null){Z.call(M,null)}else{M.updateHashFragment(ab);M.joinBoard(ab,Z)}})},leaveBoard:function(Z){if(!this.board_id){return}if(!Z){now.leaveBoard(this.board_id)}M.updateHashFragment("");this.board_id=null}};window.totalOps=0;var Q=false;var u=null;var v=null;function W(aa){Q=true;var ab=x.offset();var Z=aa.pageX-ab.left;var ac=aa.pageY-ab.top;if(z){M.doErase(Z,ac)}else{if(V){setTimeout(function(){var ad=F.prompt_handler.call(M,Y("Enter text"),"");if(ad){M.doDrawText(H,Z,ac,ad,F.font)}},200)}else{u=Z;v=ac;M.doDrawLine(H,k,Z,ac,Z,ac)}}return false}function j(aa){if(!Q){return false}var ab=x.offset();var Z=aa.pageX-ab.left;var ac=aa.pageY-ab.top;if(z){M.doErase(Z,ac)}else{if(V){}else{M.doDrawLine(H,k,Z,ac,u,v);u=Z;v=ac}}return false}function i(aa){if(!Q){return false}var ab=x.offset();if(!z&&!V){var Z=aa.pageX-ab.left;var ac=aa.pageY-ab.top;if(ac==v){ac+=1}M.doDrawLine(H,k,Z,ac,u,v)}u=null;v=null;Q=false;return false}function r(){Q=false;return false}x.mousedown(W);x.mousemove(j);x.mouseup(i);x.mouseleave(r);d("li.color li.black a",p).click();d("li.pencil li.medium a",p).click();d("li.share a",p).hide();if(window.now){now.receiveOplog=function(aa,Z){M.replayOps(aa);if(Z){Z()}};now.ready(function(){now.apiKey=F.apiKey;now.referer=window.location.href.split(/#/)[0];d("li.share a",p).show();if(M.isShared()){var aa=M.getBoardId();M.leaveBoard(true);d("li.share",p).removeClass("selected");M.joinBoard(aa,function(ab){if(ab){d("li.share",p).addClass("selected")}else{F.msgbox_handler.call(M,Y("Lost connection to shared drawing"))}})}else{F.onReady();if(F.autoJoin){var aa="";if(F.singleBoardId){aa=F.singleBoardId;d("li.share a",p).hide();M.createNamedBoard(aa,function(ab){if(!ab){F.msgbox_handler.call(M,Y("Can't join shared drawing at this time"))}});return}var Z=M.getHashFragment();if(Z){aa=Z}if(aa.length>0){M.joinBoard(aa,function(ab){if(ab){d("li.share",p).addClass("selected")}else{F.msgbox_handler.call(M,Y("Can't join shared drawing (it probably doesn't exist any more)"))}})}}}})}else{window.location.hash=""}if(B){d("li.pencil ul li.eraser",p).hide()}d(this).data("aww",M).append(K);M.resize();return M}})(jQuery);